#!/usr/bin/env bash
set -euo pipefail

if [ -f "$HOME/.config/ai-audio.env" ]; then
  # shellcheck disable=SC1090
  . "$HOME/.config/ai-audio.env"
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_PATHS=("$SCRIPT_DIR/dictation-lib.sh" "$HOME/.local/lib/dictation-lib.sh")
for _lib in "${LIB_PATHS[@]}"; do
  if [ -f "$_lib" ]; then
    # shellcheck source=scripts/dictation-lib.sh
    . "$_lib"
    break
  fi
done
unset _lib

STATE_DIR="${XDG_RUNTIME_DIR:-/tmp}/dictation"
PID_FILE="$STATE_DIR/rec.pid"
WAV_FILE="$STATE_DIR/rec.wav"
LOG_FILE="$STATE_DIR/dictation.log"
LOCK_FILE="$STATE_DIR/lock"
START_MS_FILE="$STATE_DIR/start_ms"
LAST_DOWN_MS_FILE="$STATE_DIR/last_down_ms"
MAX_RECORD_MS="${DICTATION_MAX_RECORD_MS:-15000}"
LOG_MAX_LINES=10000
LOG_KEEP_LINES=5000
mkdir -p "$STATE_DIR"

if [ -f "$LOG_FILE" ]; then
  log_lines="$(wc -l < "$LOG_FILE" 2>/dev/null || echo 0)"
  if [ "$log_lines" -gt "$LOG_MAX_LINES" ]; then
    tail -n "$LOG_KEEP_LINES" "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
  fi
fi

exec 9>"$LOCK_FILE"
flock 9

now_ms="$(date +%s%3N)"
printf '%s start keydown\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
printf '%s\n' "$now_ms" > "$LAST_DOWN_MS_FILE"

if [ -f "$PID_FILE" ]; then
  pid="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    printf '%s already_recording pid=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$pid" >> "$LOG_FILE"
    exit 0
  fi
fi

rm -f "$PID_FILE" "$START_MS_FILE"

log_mic_state "$LOG_FILE"
mic_source="$(get_mic_source)"

ffmpeg -nostdin -loglevel error -f pulse -i "${mic_source:-default}" -ac 1 -ar 16000 -y "$WAV_FILE" 9>&- >/dev/null 2>&1 &
pid=$!
echo "$pid" > "$PID_FILE"
printf '%s\n' "$now_ms" > "$START_MS_FILE"
printf '%s recorder_pid=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$pid" >> "$LOG_FILE"

(
  sleep "$((MAX_RECORD_MS / 1000))"
  if [ -f "$PID_FILE" ] && [ "$(cat "$PID_FILE" 2>/dev/null || true)" = "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    printf '%s auto_stop_timeout_ms=%s pid=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$MAX_RECORD_MS" "$pid" >> "$LOG_FILE"
    "$HOME/.local/bin/dictate-stop" >/dev/null 2>&1 || true
  fi
) 9>&- >/dev/null 2>&1 &
