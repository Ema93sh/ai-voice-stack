#!/usr/bin/env bash
set -euo pipefail

if [ -f "$HOME/.config/ai-audio.env" ]; then
  # shellcheck disable=SC1090
  . "$HOME/.config/ai-audio.env"
fi

STATE_DIR="${XDG_RUNTIME_DIR:-/tmp}/dictation"
PID_FILE="$STATE_DIR/rec.pid"
WAV_FILE="$STATE_DIR/rec.wav"
LOG_FILE="$STATE_DIR/dictation.log"
LOCK_FILE="$STATE_DIR/lock"
START_MS_FILE="$STATE_DIR/start_ms"
LAST_DOWN_MS_FILE="$STATE_DIR/last_down_ms"
MAX_RECORD_MS="${DICTATION_MAX_RECORD_MS:-15000}"
mkdir -p "$STATE_DIR"

get_mic_source() {
  local src=""
  local preferred=""
  if command -v pactl >/dev/null 2>&1; then
    if [ -n "${DICTATION_SOURCE:-}" ]; then
      if pactl list short sources | awk '{print $2}' | rg -Fx -- "${DICTATION_SOURCE}" >/dev/null 2>&1; then
        printf '%s' "${DICTATION_SOURCE}"
        return
      fi
    fi

    preferred="$(pactl list short sources | awk '/HyperX_SoloCast|HyperX SoloCast|usb-HP__Inc_HyperX_SoloCast/ {print $2; exit}')"
    if [ -n "$preferred" ]; then
      printf '%s' "$preferred"
      return
    fi

    src="$(pactl get-default-source 2>/dev/null || true)"
    if [ -z "$src" ]; then
      src="$(pactl info 2>/dev/null | awk -F': ' '/Default Source/ {print $2; exit}' || true)"
    fi
  fi
  printf '%s' "$src"
}

get_mic_mute() {
  local src="$1"
  if [ -z "$src" ] || ! command -v pactl >/dev/null 2>&1; then
    printf 'unknown'
    return
  fi
  pactl get-source-mute "$src" 2>/dev/null | awk '{print $2}' || printf 'unknown'
}

get_mic_volume() {
  local src="$1"
  if [ -z "$src" ] || ! command -v pactl >/dev/null 2>&1; then
    printf '?'
    return
  fi
  pactl get-source-volume "$src" 2>/dev/null | awk -F'/' 'NR==1 {gsub(/ /, "", $2); print $2; exit}' || printf '?'
}

exec 9>"$LOCK_FILE"
flock 9

now_ms="$(date +%s%3N)"
printf '%s start keydown\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
printf '%s\n' "$now_ms" > "$LAST_DOWN_MS_FILE"

if [ -f "$PID_FILE" ]; then
  pid="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    printf '%s already_recording pid=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$pid" >> "$LOG_FILE"
    exit 0
  fi
fi

rm -f "$PID_FILE" "$START_MS_FILE"

mic_source="$(get_mic_source)"
mic_mute="$(get_mic_mute "$mic_source")"
mic_vol="$(get_mic_volume "$mic_source")"
mic_state="ON"
if [ "$mic_mute" = "yes" ]; then
  mic_state="OFF"
fi
printf '%s mic_state=%s source=%s volume=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$mic_state" "${mic_source:-default}" "$mic_vol" >> "$LOG_FILE"

ffmpeg -nostdin -loglevel error -f pulse -i "${mic_source:-default}" -ac 1 -ar 16000 -y "$WAV_FILE" 9>&- >/dev/null 2>&1 &
pid=$!
echo "$pid" > "$PID_FILE"
printf '%s\n' "$now_ms" > "$START_MS_FILE"
printf '%s recorder_pid=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$pid" >> "$LOG_FILE"

(
  sleep "$((MAX_RECORD_MS / 1000))"
  if [ -f "$PID_FILE" ] && [ "$(cat "$PID_FILE" 2>/dev/null || true)" = "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    printf '%s auto_stop_timeout_ms=%s pid=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$MAX_RECORD_MS" "$pid" >> "$LOG_FILE"
    "$HOME/.local/bin/dictate-stop" >/dev/null 2>&1 || true
  fi
) 9>&- >/dev/null 2>&1 &
