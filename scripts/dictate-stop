#!/usr/bin/env bash
set -euo pipefail

if [ -f "$HOME/.config/ai-audio.env" ]; then
  # shellcheck disable=SC1090
  . "$HOME/.config/ai-audio.env"
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_PATHS=("$SCRIPT_DIR/dictation-lib.sh" "$HOME/.local/lib/dictation-lib.sh")
for _lib in "${LIB_PATHS[@]}"; do
  if [ -f "$_lib" ]; then
    # shellcheck source=scripts/dictation-lib.sh
    . "$_lib"
    break
  fi
done
unset _lib

STATE_DIR="${XDG_RUNTIME_DIR:-/tmp}/dictation"
PID_FILE="$STATE_DIR/rec.pid"
WAV_FILE="$STATE_DIR/rec.wav"
LOG_FILE="$STATE_DIR/dictation.log"
LOCK_FILE="$STATE_DIR/lock"
START_MS_FILE="$STATE_DIR/start_ms"
LAST_DOWN_MS_FILE="$STATE_DIR/last_down_ms"
MIN_HOLD_MS="${DICTATION_MIN_HOLD_MS:-250}"
KEYUP_DEBOUNCE_MS="${DICTATION_KEYUP_DEBOUNCE_MS:-120}"
TMUX_SUBMIT_DELAY_S="${DICTATION_TMUX_SUBMIT_DELAY_S:-0.12}"
AUTO_SUBMIT="${DICTATION_AUTO_SUBMIT:-1}"
mkdir -p "$STATE_DIR"

resolve_tmux_pane() {
  local client_tty pane_id

  command -v tmux >/dev/null 2>&1 || return 1

  client_tty="$(tmux list-clients -F '#{client_tty}' 2>/dev/null | head -n1 || true)"
  [ -n "$client_tty" ] || return 1

  pane_id="$(tmux display-message -p -t "$client_tty" '#{pane_id}' 2>/dev/null || true)"
  [ -n "$pane_id" ] || return 1

  printf '%s' "$pane_id"
}

insert_text_tmux() {
  local text="$1"
  local pane_id buffer_name

  pane_id="$(resolve_tmux_pane)" || return 1

  buffer_name="dictation-$$"
  tmux set-buffer -b "$buffer_name" -- "$text" >/dev/null 2>&1 || return 1
  tmux paste-buffer -b "$buffer_name" -d -t "$pane_id" >/dev/null 2>&1 || return 1
}

press_enter_tmux() {
  local pane_id

  pane_id="$(resolve_tmux_pane)" || return 1
  sleep "$TMUX_SUBMIT_DELAY_S"
  tmux send-keys -t "$pane_id" Enter >/dev/null 2>&1 || return 1
}

insert_text() {
  local text="$1"

  if insert_text_tmux "$text"; then
    printf '%s inserted_via_tmux\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
    return 0
  fi

  plat_insert_text "$text"
  printf '%s inserted_via_platform\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
}

press_enter() {
  if press_enter_tmux; then
    printf '%s enter_via_tmux\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
    return 0
  fi

  plat_press_enter
  printf '%s submit_via_platform\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
}

exec 9>"$LOCK_FILE"
flock 9

if [ ! -f "$PID_FILE" ]; then
  exit 0
fi

pid="$(cat "$PID_FILE" 2>/dev/null || true)"
if [ -z "$pid" ] || ! kill -0 "$pid" 2>/dev/null; then
  rm -f "$PID_FILE" "$START_MS_FILE"
  exit 0
fi

printf '%s stop keyup\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"

now_ms="$(plat_now_ms)"
last_down_ms="$(cat "$LAST_DOWN_MS_FILE" 2>/dev/null || echo 0)"
since_down_ms=$((now_ms - last_down_ms))
if [ "$since_down_ms" -lt "$KEYUP_DEBOUNCE_MS" ]; then
  printf '%s ignored_repeat_keyup_ms=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$since_down_ms" >> "$LOG_FILE"
  exit 0
fi

start_ms="$(cat "$START_MS_FILE" 2>/dev/null || echo 0)"
elapsed_ms=$((now_ms - start_ms))
if [ "$elapsed_ms" -lt "$MIN_HOLD_MS" ]; then
  printf '%s ignored_short_hold_ms=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$elapsed_ms" >> "$LOG_FILE"
  exit 0
fi

kill -INT "$pid" 2>/dev/null || true
for _ in $(seq 1 40); do
  kill -0 "$pid" 2>/dev/null || break
  sleep 0.05
done
kill -TERM "$pid" 2>/dev/null || true
rm -f "$PID_FILE" "$START_MS_FILE"

log_mic_state "$LOG_FILE"

if [ ! -s "$WAV_FILE" ]; then
  printf '%s no_audio_captured\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
  exit 0
fi

TRANSCRIBE_BIN="${DICTATION_TRANSCRIBE_BIN:-$HOME/.local/bin/transcribe-audio}"
if ! RAW_TEXT="$("$TRANSCRIBE_BIN" "$WAV_FILE" 2>>"$LOG_FILE")"; then
  printf '%s transcribe_failed provider=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "${DICTATION_PROVIDER:-faster-whisper}" >> "$LOG_FILE"
  exit 0
fi

TEXT="$(printf '%s' "$RAW_TEXT" | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g; s/^ //; s/ $//')"

if [ -z "$TEXT" ]; then
  printf '%s no_speech_detected\n' "$(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
  exit 0
fi

insert_text "$TEXT"
if [ "$AUTO_SUBMIT" = "1" ]; then
  press_enter
fi
printf '%s transcription_len=%s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "${#TEXT}" >> "$LOG_FILE"
